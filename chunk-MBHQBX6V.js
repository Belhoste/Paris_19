import{J as L}from"./chunk-4EWWVG4N.js";import{K as I,Q as P,U as w,n as f,p as C,s as k}from"./chunk-ZCBSTZ3M.js";var T=(()=>{let h=class h{constructor(){this.request=w(L),this.closuresCache={},this.closuresLoaded={},this.closuresLoading={}}chunkArray(o,r){let t=[];for(let s=0;s<o.length;s+=r)t.push(o.slice(s,s+r));return t}buildCirrusQueries(o,r,t){let s=r.tokens.map(e=>e.endsWith("*")?e:e+"*"),i=o.entityNamespace??120,m=e=>{let n=[`haswbstatement:P131=${e}`,...r.extraClauses,...s].join(" "),u=`https://database.factgrid.de/w/api.php?action=query&list=search&format=json&origin=*&srsearch=${encodeURIComponent(n)}&srnamespace=${i}&srlimit=${t}`;return this.request.getItem(u).pipe(C(a=>(a?.query?.search||[]).map(l=>l.title.match(/Q\d+/)?.[0]).filter(l=>!!l)))},c=o.p131Roots.map(e=>m(e));return k(c).pipe(C(e=>Array.from(new Set(e.flat()))))}buildSparqlFallback(o,r,t){let s=r.tokens.map(n=>n.toLowerCase().replace(/"/g,""));if(!s.length)return f([]);let i=s.map(n=>`FILTER(CONTAINS(LCASE(?label), "${n}")).`).join(" "),c=`SELECT DISTINCT ?item WHERE { VALUES ?root { ${o.p131Roots.map(n=>`wd:${n}`).join(" ")} } ?item wdt:P131* ?root . ?item rdfs:label ?label . FILTER(lang(?label)='${t}') ${i} } LIMIT 300`,e="https://database.factgrid.de/sparql?query="+encodeURIComponent(c)+"&format=json";return this.request.getItem(e).pipe(C(n=>{let u=new Set,a=n?.results?.bindings||[];for(let l of a){let d=(l.item?.value||"").match(/Q\d+/)?.[0];d&&u.add(d)}return Array.from(u)}))}searchIds(o,r,t=2,s="en"){let i=(r||"").trim();if(i.length<t)return f([]);let m=o.termPreprocess(i),c=i.length===2?100:200;return this.buildCirrusQueries(o,m,c).pipe(I(e=>(e?.length||0)>0||!o.enableSparqlFallback?f(e):this.buildSparqlFallback(o,m,s).pipe(C(n=>Array.from(new Set([...e||[],...n]))))))}fetchEntities(o,r){if(!o?.length)return f([]);let s=this.chunkArray(o,50).map(i=>{let c=`https://database.factgrid.de/w/api.php?action=wbgetentities&ids=${i.join("|")}&format=json&languages=${r}&origin=*`;return this.request.getItem(c).pipe(C(e=>e&&e.entities?Object.values(e.entities):[]))});return s.length?k(s).pipe(C(i=>i.flat())):f([])}loadClosures(o,r){let t=o.name;if(this.closuresCache[t]||(this.closuresCache[t]={}),this.closuresLoaded[t])return f(this.closuresCache[t]);if(this.closuresLoading[t])return f(this.closuresCache[t]);this.closuresLoading[t]=!0;for(let c of r)this.closuresCache[t][c.key]||(this.closuresCache[t][c.key]=new Set([c.occupationId]));let s=r.map(c=>`wd:${c.occupationId}`).join(" ");if(!s)return this.closuresLoaded[t]=!0,this.closuresLoading[t]=!1,f(this.closuresCache[t]);let i=`SELECT ?root ?occ WHERE { VALUES ?root { ${s} } ?occ wdt:${o.subclassProperty}* ?root . }`,m=`https://database.factgrid.de/sparql?format=json&query=${encodeURIComponent(i)}`;return this.request.getItem(m).pipe(C(c=>{let e=c?.results?.bindings||[];for(let n of e){let u=n.root?.value?.match(/Q\d+/)?.[0],a=n.occ?.value?.match(/Q\d+/)?.[0];if(!u||!a)continue;let l=r.find(d=>d.occupationId===u);if(!l)continue;let p=this.closuresCache[t][l.key]||new Set;p.add(u),p.add(a),this.closuresCache[t][l.key]=p}return this.closuresLoaded[t]=!0,this.closuresLoading[t]=!1,this.closuresCache[t]}))}filterEntitiesByClasses(o,r,t,s,i,m,c){if(!r?.length)return[];let e=o.availableFilters.reduce((u,a)=>(u[a.key]=a.occupationId,u),{}),n=o.claimProperties;return r.filter(u=>{let a=[];for(let p of n){let d=u.claims?.[p]||[];for(let b of d){let g=b?.mainsnak?.datavalue?.value?.id;g&&a.push(g)}}if(!a.length&&(t.length||i))return!1;let l=Array.from(new Set(a));if(i){let p=m.filter(d=>d.allOf.length>0);return p.length?p.some(d=>d.allOf.every(b=>{let g=s[b]||new Set([e[b]]);return l.some(S=>g.has(S))})):!0}return t.length?c?t.some(p=>{let d=s[p]||new Set([e[p]]);return l.some(b=>d.has(b))}):t.every(p=>{let d=s[p]||new Set([e[p]]);return l.some(b=>d.has(b))}):!0})}finalTextFilter(o,r,t,s){let i=(t||"").toString();if(!i)return r;if(o.finalFilterMode==="substring"){let e=i.toLowerCase();return r.filter(n=>{let u=n.labels?.[s]?.value?.toLowerCase?.()||n.label?.toLowerCase?.()||"",a=(n.aliases?.[s]||[]).map(l=>(l.value||l).toString().toLowerCase());return u.includes(e)||a.some(l=>l.includes(e))})}let c=i.replace(/^Paris,\s*/i,"").split(/\s+/).filter(e=>e.length>0).map(e=>e.toLowerCase());return c.length?r.filter(e=>{let n=(e.label||e.labels?.[s]?.value||"").toLowerCase(),u=Array.isArray(e.aliases)?e.aliases.map(a=>(a.value||a||"").toLowerCase()):(e.aliases?.[s]||[]).map(a=>a.value.toLowerCase());return c.every(a=>n.includes(a)||u.some(l=>l.includes(a)))}):r}};h.\u0275fac=function(r){return new(r||h)},h.\u0275prov=P({token:h,factory:h.\u0275fac,providedIn:"root"});let y=h;return y})();function q(y){let h=(y||"").trim();return h?{extraClauses:[],tokens:[h]}:{extraClauses:[],tokens:[]}}function E(y){let h=(y||"").trim(),Q=/^Paris,\s*/i.test(h),r=h.replace(/^Paris,\s*/i,"").split(/\s+/).filter(s=>!!s);return{extraClauses:Q?[]:['"Paris,"'],tokens:r}}var N={name:"people",p131Roots:["Q268686","Q22241"],claimProperties:["P165","P106"],subclassProperty:"P3",availableFilters:[{key:"painter",occupationId:"Q36783"},{key:"writer",occupationId:"Q23190"},{key:"actor",occupationId:"Q176304"},{key:"physician",occupationId:"Q38980"},{key:"scientist",occupationId:"Q206759"},{key:"bookseller",occupationId:"Q36507"},{key:"printer",occupationId:"Q38848"},{key:"engraver",occupationId:"Q162783"}],entityNamespace:120,termPreprocess:q,enableSparqlFallback:!1,finalFilterMode:"substring"},O={name:"places",p131Roots:["Q314208","Q147167"],claimProperties:["P2"],subclassProperty:"P3",availableFilters:[{key:"address",occupationId:"Q16200"},{key:"voie",occupationId:"Q266101"},{key:"building",occupationId:"Q40261"},{key:"theatre",occupationId:"Q396161"}],entityNamespace:120,termPreprocess:E,enableSparqlFallback:!0,finalFilterMode:"allTokens"};export{T as a,N as b,O as c};
